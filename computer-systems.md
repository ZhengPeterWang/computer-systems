# CS 3410

百年汪大传承知识火炬，造福一代代汪铮人民。

本文档为CS 3410预习的笔记。这门课主要讨论计算机系统的构成，以及处理器、内存和并行是如何工作的。本课程架起了硬件和软件之间的桥梁。

基础计算机可以看成由两个部分组成：内存(memory)和处理器(processor)。Central Processing Unit（CPU）就是现代电脑的处理器，而Random Access Memory(RAM)就是现代电脑的内存。处理器内部也有一些内部存储空间，称为寄存器(register），而处理器就相当于一个图灵机，不停地在不同状态间切换并修改寄存器的值，从而完成计算。内存则提供了远比处理器多的存储空间。两者是通过总线(bus)联系起来的。

为了与硬件交互，我们需要一种把内存和处理器抽象的平台，这样我们就能站在软件的角度理解硬件。这个平台叫指令集架构(Instruction Set Architecture)。

## 第1章 什么是电脑？电脑是怎么工作的？

目前的电脑主要有四种：个人电脑(PC)，服务器(server)，嵌入式微处理器（代表为单片机），和个人移动设备(PMD)。云计算正逐渐替代传统的服务器。

### 1.1 电脑硬件简介

一个计算机主要由五个部分组成：**输入设备**（比如麦克风，键盘，鼠标），**输出设备**（比如音响，显示器，触摸屏），**内存，数据通路**(datapath)和**控制中心**，其中后两个经常并起来称为**处理器**。

#### 输入和输出设备

##### 图形显示

现代电脑是用二进制数字存储图像的。每个图像都被转成RGB格式表示的像素，每个像素都有三个字节，分别表示红色、绿色、黑色。数以万计的像素形成了显示器。现代的显示器大都是液晶显示器，是利用液晶分子通电后会改变其偏振属性，从而改变偏振光光强的方法控制不同单色光强度，从而显示出不同颜色的。现代电脑控制显示图片的工具是帧缓冲器(frame buffer)，需要显示的位图(bit map)先存储到帧缓冲器，再按照刷新速率不断地把信息输送给显示器。

##### 触摸设备

现代移动设备大量采用了电容感应方案。绝缘体玻璃被人体（导体）触摸后会改变屏幕的电场进而改变其电容，从而能够让系统电路获得感应信息。当然键盘等传统的靠压力通断电路开关的触摸设备现仍然大量地在个人电脑中使用。

#### 处理器

处理器又称**中央处理单元**(CPU)，主要包括控制中心和数据通路。数据通路是完成全部计算的主要设备，而控制中心则负责解析需要完成哪些计算。处理器一般被安放在**芯片**(chip)上。我们将在之后的更多章节讨论处理器。

#### 内存

现代的内存主要以**随机存取内存**(RAM)为形式。内存主要有动态随机存储内存（DRAM）和静态随机存储内存（SRAM，又称缓存,cache）。SRAM比DRAM更贵，内存容量更小，但更容易访问。现代电脑运用了多种不同的内存形成一套内存等级，以便最大限度地利用所有资源。

学习之后的课程后就能知道，**临时内存**（volatile memory)主要是通过控制电路某部分电压是否大于阈值来实现的。一旦断电，所有临时内存就都会丢失。因此，还有另一种内存称为**永久内存**(nonvolatile memory)，把信息用物理的方式存起来。临时内存因此又称主内存，而永久内存又称副内存。

永久内存主要有磁盘（magnetic disk，又称硬盘,hard disk, hard drive）和闪存(flash drive)。磁盘由盘片和磁头组成。盘片上布满了磁性物质。当我们向磁盘写信息时，磁头会去改变硬盘上某个位置的磁极。当我们向硬盘读信息时，磁头会去感应硬盘上某个位置的磁阻。为了读写盘片上的某个位置，磁头和盘片必须不停高速旋转以找到其对应的内存，这个过程会散发大量的热。磁盘内部还有一个微处理器，负责把读到的内容传递给数字电路。闪存则用电容存储信息。当闪存中的浮门带电时，闪存就拥有高电压，因此1就会被存储在这个晶体管。

内存全名 | 内存简称 | 存取时间 | 1GB存储的价格（2012）
-|-|-|-
静态随机存取内存 | SRAM | 10ns | ?
动态随机存储内存 | DRAM | 50ns | $5 - $10
磁盘 | 硬盘 | 5 - 20 ms | $0.05 - $0.1
闪存 | flash | 0.1 ms | $1

我们将在之后的更多章节讨论内存，尤其是临时内存。

#### 网络

网络是现代电脑必不可缺的部分。它能够允许信息交互、资源共享、远程控制。网络有两种规模：局域网(local area network, LAN)和广域网(wide area network, WAN)。现代局域网速可以达到1-40GB/s，而通过光纤宽带实现的广域网速业已达到1GB/s。以wifi标准和通信网络为基础的无线网现在成为全新的网络形式，目前一般的网速可以达到100MB/s。

### 1.2 性能

电脑的性能可以用响应时间和数据吞吐量描述。响应时间分为CPU时间和获得内存、IO等的时间，而CPU时间又分为系统CPU时间和用户CPU时间。我们之后主要讨论CPU时间，尤其是用户CPU时间。

决定性能的唯一标准是执行时间，但在不同的CPU上不同的程序执行时间有很大差别。一个程序的执行时间由指令个数、每指令执行的钟表圈数(CPI)、以及单位钟表圈数执行时间决定。

### 1.3 指令集架构（电脑架构）

抽象性原理要求我们在研究更抽象内容时忽略具体实现细节，只需要把更具体的内容封装抽象为一个个模型即可。现代电脑最重要的一个抽象就是硬件与最低级软件之间的交互，这个交互模型称为**指令集架构**(Instruction Set Architecture)，简称**架构**(architecture)。这个抽象的架构是一套规则组成的要求，而具体的硬件应该**实现**这个要求。

在第3章中介绍处理器、第4章中介绍内存时，我们将更详细地讨论指令集架构。

## 第2章 电脑的电路基础

电脑是一个非常复杂的系统，但它的核心——处理器和内存——也不过是由大量三极管组成的一个电路。本章主要讨论一个个电路元件是如何被层层聚合，层层抽象，从而构成计算的基本单位和存储的基本单位的，它们将会成为处理器和内存的基础。

### 2.1 逻辑门电路

电路中把开关串联和并联可以构成一系列门电路。而NPN型与PNP型三极管则可以通过控制基极电压大小来控制电路通断，因此它们的恰当组合也能形成门电路（只不过它们只能形成非门和或非门），从而数字电路的通断不再需要开关的机械控制。在具体实现中我们不去管门电路如何实现，而只是把它抽象成一个可以满足我们要求的电路元件，这是从电路到电脑的第一层抽象。

电路与布尔代数表达式和命题逻辑表达式之间有一一对应的关系。任何电路都有一个真值表，能用合取范式设计出来。这是门电路被广泛应用于逻辑设计的原因。选择器(multiplexor)是一种重要的门电路。

一个重要的问题是，给出一个真值表，能否造出一个满足该真值表的表达式，使其运用最少的逻辑运算符（最少的门电路器件）。Karnaugh Maps是一种可以寻找该表达式的方法。

### 2.2 算术计算

以不同方式组合门电路，可以实现算术计算，这就是电脑被称为计算机的原因。

通过门电路可以设计一个带进位功能的全加法器，大致由6个门电路组成。加法器与加法器之间可以串联，这样理论上就可以设计出任意比特的加法器。用“2补法”构造每个正数的相反数可以构造与无符号整数兼容的有符号整数，这样就可以把加法运算的范围扩充到负数。减法就是加上相反数，因此减法也能用加法器串联组成，且能够与加法运算共用。8个比特的整数加法这样需要50个门电路左右就能完成了。注意一般比特的数目有限，因此大数字会导致计算越界，越界时可以通过一个选择器侦查结果符号是否正确，并抛出异常。

乘法、除法、甚至浮点数的计算，都能通过恰当的表示方式用比特和门电路的方式完成。当然门电路也能被用来比较数字大小。通过右移左移比特的方式还能完成乘方和开方。这样所有常用的算术计算都能用门电路完成了。

### 2.3 寄存器、内存

如何在一个瞬息万变的电路中存储什么信息呢？当然可以用电容是否带电的方式完成。但事实上只用门电路就可以实现存储信息。门电路可以组成多种多样的电器元件，这是在电脑组成中的第二层抽象。

SR锁存器(latch)是第一个可以存储一比特并改变其值的门电路。但SR锁存器中有一个态被禁止。D锁存器改进了SR锁存器，其中不再有禁止态，但D锁存器中存储的信号随外加信号的大小改变，也就是我们还是无法控制是修改这个比特还是存储这个比特。

为了实现周期性地决定是否存取某个内存，我们需要构造一个钟。电路中的钟就是周期信号，在本课程中我们使用正负边触发型钟，它是由电平的突然上升和下降来触发信号的。其他的还有电平触发型钟等。把两个D锁存器串联，再给它们接入相反的钟表信号，就造出了一个D触发器(flip-flop)。D触发器的特点是接受D信号，且只在钟信号突然上升或下降时才会根据D信号修改其内部存储的比特。这样11个门电路就能造出一个D触发器，它就能根据钟信号来存储一个比特。

将大量D触发器并联，分享一个钟信号，就构成了一个寄存器(register)，例如32比特寄存器，这是第三层抽象。大量的寄存器又组成了一个叫寄存器文件(register file)的单元，通过与编码器(encoder)和解码器(decoder)的组合可以实现写内存，通过与选择器的组合可以实现读内存。在寄存器文件中存储非常快速，只经过几个门电路就能完成，但它要实现大内存存储很困难，因为造不出太大的选择器。

存储大内存需要对寄存器文件改进。可以通过三态缓冲器（tri-state buffer）控制一个时间只有一个寄存器输出，且输出到一条所有寄存器共享的总线(bus)中去，这样就没必要造特别大的选择器了。利用这个思想可以造出静态随机存储内存(SRAM)。大量触发器可以通过二维的方式组织，总线就是word line和bit line，每轮钟表周期只读或写一个内存，这又是一层抽象。通过优化触发器可以让6个三极管就能存储一个比特，实现高效存储。

更高效的存储还可以通过DRAM来实现，它可以利用电容存储，但其存储速度比SRAM慢。可以看出，门电路构成了所有临时内存的框架。

### 2.4 顺序逻辑、有限状态机

在形式语言与自动机中我们已经讨论过有限状态机。把寄存器文件与带输入输出的组合逻辑电路（已经在2.1节讨论过）结合起来，就构成了一套顺序逻辑电路，也就能实现有限状态机。这样，门电路就提供了一套极其丰富的计算工具。

## 第3章 处理器

在拥有计算工具和内存之后，我们下一步将会考虑如何把它们组织起来实现指令。一个重要的经验是，指令（程序）也应该像数据一样存起来（存在寄存器文件中），只不过应该与数据分开存储。这样我们就能拥有更灵活的执行指令的工具（没有这个功能那么GOTO、递归、函数调用等等都将称为不可能）。本章中，我们以RISC处理器为例，阐述一套处理器的指令集架构是如何实现的，并讨论处理器的流水线优化。

### 3.1 RISC汇编语言

汇编语言(assembly language)是处理器的语言，也是指令集架构的语言。x86，ARM等是常用的汇编语言。本节我们既会讨论RISC汇编语言，也会讨论如何用上章的门电路元件实现这个语言的要求。

RISC类汇编语言的指令有算术逻辑计算（加减乘除左右移）、内存存取、控制执行语句等。指令的词法有4种：R型、I型、S型、U型等。

RISC类汇编语言可以用RISC-V处理器实现。这个处理器分五部分：获取指令、解码指令、执行、内存获取、回写寄存器。每个指令都会一次走过处理器的五个部分：第一步，从程序内存中读取要执行的指令。第二步，从寄存器文件中读取需要处理的临时内存。第三步，在ALU（算数逻辑单元）中执行指令。第四步，修改数据内存中的相应位置。第五步，把临时变量的更改结果重新存到寄存器，准备执行下一个指令。

算术与逻辑计算是比较简单的部分，只需要利用ALU就可以了。特别注意的是有中间值的算术计算，需要经过额外处理在其他地方传输中间值信号，还要注意中间值必须增位才能达到32位的寄存器存储值。

内存的获取和更改需要不停地读写SRAM或者DRAM或者其他。一般需要指明地址然后输入内存就可以了。注意RISC-V和x86认为小的数应该放在靠前的内存，而MIPS则认为大的数应该放在靠前的内存，这两者无优劣之分。

为了实现跳步执行，在寄存器获得某些信息后控制中心应该把运算结果发回一个加法器，控制程序内存从而改变下一个调用的语句。RISC还支持按照某条件进行比较，确认下一步应执行哪一行指令，这样我们就设计完成了能实现RISC语言的RISC-V处理器的基本框架。

### 3.2 流水线优化

